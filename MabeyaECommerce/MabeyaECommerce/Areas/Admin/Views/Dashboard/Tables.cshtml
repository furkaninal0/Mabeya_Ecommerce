@inject MabeyaDbContext dbContext
@{
    ViewData["Title"] = "Satış ve Yorumlar";

    var monthNames = System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.AbbreviatedMonthNames.Where(p => !string.IsNullOrEmpty(p));
    var annualSales = dbContext
    .shoppedOrders.Where(p => p.Status != OrderStatus.Cancelled)
    .Include(p => p.Order_Items).GroupBy(p => p.Date.Month)
    .Select(p => new { p.Key, Total = p.Sum(q => q.Order_Items.Sum(r => r.Quantity * r.Price)) })
    .ToList();

    var monthlySales = Enumerable.Range(1, 12).Select(p => annualSales.SingleOrDefault(q => q.Key == p)?.Total ?? 0);
    var sales = dbContext.shoppedOrders.Where(p => p.Status != OrderStatus.Cancelled).Include(p => p.Order_Items).Sum(p => p.Order_Items.Sum(q => q.Quantity * q.Price));

    var topProducts = dbContext.shoppedOrder_Items.Where(p => p.ShoppedOrder.Status != OrderStatus.Cancelled).
    GroupBy(p => p.Product).Select(p => new { p.Key.Id, p.Key.Name, Count = p.Count() })
    .OrderByDescending(p => p.Count).Take(10);
    var orders = dbContext.shoppedOrders.Count(p => p.Status != OrderStatus.Cancelled);


    var topviewedProduct = dbContext.Products
        .OrderByDescending(p => p.Views)
        .Take(5)
        .Select(p => new
        {
            p.Id,
            p.Name,
            ViewCount = p.Views
        })
        .ToList();


}


<div class="navbar-menu-wrapper d-flex align-items-top">
    <ul class="navbar-nav">
        <li class="nav-item fw-semibold d-none d-lg-block ms-0">
            <h3 class="welcome-sub-text text-bg-info">Bu haftaki performans özetiniz.</h3>
        </li>
    </ul>
</div>

<div class="col-sm-12">
    <div class="home-tab">
       

        <div class="tab-content tab-content-basic">
            <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview">
                <div class="row">
                    <div class="col-12 grid-margin stretch-card">
                        <div class="card card-rounded">
                            <div class="card-body">
                                <div class="col-12">
                                    <div class="d-sm-flex justify-content-between align-items-start">
                                        <div>
                                            <h4 class="card-title card-title-dash">Pazardaki Yıllık Genel Bakış</h4>
                                            <p class="card-subtitle card-subtitle-dash">Aşağıdaki Yıllık Brüt Kazanç Oranlarınız</p>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12 col-md-8">
                                            <div class="card">
                                                <div class="card-body">
                                                    <canvas id="annualSales"></canvas>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-12 col-md-4">

                                            <div class="card bg-success text-white mb-3 w-100">
                                                <div class="card-body d-flex gap-3">
                                                    <i class="bi bi-currency-exchange display-1"></i>
                                                    <div class="flex-fill d-flex flex-column text-end">
                                                        <div class="small mb-3">Siparişlerin Toplamı</div>
                                                        <div class="h3">@sales.ToString("n0") TL</div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="card bg-warning text-white mb-3 w-100">
                                                <div class="card-body d-flex gap-3">
                                                    <i class="bi bi-bag-heart display-1"></i>
                                                    <div class="flex-fill d-flex flex-column text-end">
                                                        <div class="small mb-3">Siparişlerin Adedi</div>
                                                        <div class="display-4">@orders.ToString("n0") Adet</div>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>


                    </div> 
                </div>
                <hr />

                <div class="row">
                    <div class="col-12 ">
                        <div class="card h-100">
                            <div class="card-header bg-primary">
                                <h5 class="text-white">En Çok Satan 10 Ürün</h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-bordered table-striped">
                                    <thead>
                                        <tr>
                                            <th>Ürün Fotoğrafı</th>
                                            <th>Ürün Adı</th>
                                            <th>Ürün Adet</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var products in topProducts)
                                        {
                                            <tr>
                                                <td>
                                                    <img src="@Url.Action("Product" , "Images" , new {area="" , id=products.Id})" alt="@products.Name" height="100" />
                                                </td>
                                                <td>
                                                    <a asp-action="Edit" asp-controller="Products" asp-route-id="@products.Id"> @products.Name</a>
                                                </td>
                                                <td>
                                                    @products.Count.ToString("n0")
                                                </td>
                                            </tr>
                                        }
                                    </tbody>

                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <hr />

                <div class="row">
                    <div class="col-12 ">
                        <div class="card h-100">
                            <div class="card-header bg-primary">
                                <h5 class="text-white">En Çok Görüntülenen 10 Ürün</h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-bordered table-striped">
                                    <thead>
                                        <tr>
                                            <th>Ürün Fotoğrafı</th>
                                            <th>Ürün Adı</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var product in topviewedProduct)
                                        {
                                            <tr>
                                                <td>
                                                    <img src="@Url.Action("Product" , "Images" , new {area="" , id=product.Id})" alt="@product.Name" height="100" />
                                                </td>
                                                <td>
                                                    <a asp-action="Edit" asp-controller="Products" asp-route-id="@product.Id"> @product.Name</a>
                                                </td>
                                              
                                            </tr>
                                        }
                                    </tbody>

                                </table>
                            </div>
                        </div>
                    </div>
                </div>


            </div> 
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
          var annualSalesCtx = document.getElementById("annualSales");
  new Chart(annualSalesCtx, {
      type: 'bar',
      data: {

          labels: [@Html.Raw(string.Join(",", monthNames.Select(p=> $"'{p}'")))],
          datasets : [
          {
              label: 'Toplam Satış',
              data: [@string.Join(",", monthlySales)],
              borderColor: 'rgba(0,0,0,1)',
              backgroundColor: 'antiquewhite',
              borderWidth: 2,
              borderRadius: 16,
              borderSkipped: false,

              },
          ]
      }
   });
    </script>
}
