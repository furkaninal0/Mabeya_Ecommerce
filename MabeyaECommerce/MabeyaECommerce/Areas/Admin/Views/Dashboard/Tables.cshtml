@inject MabeyaDbContext dbContext
﻿
@{

    ViewData["Title"] = "Satış ve Yorumlar";

    var lastMonthDate = DateTime.Now.AddDays(-30);

    // ---- BRÜT GELİR (son 30 gün) ----
    var last30DaysGross = dbContext.shoppedOrders
      .Where(p => p.Status == OrderStatus.Shipped && p.Date >= lastMonthDate)
      .Include(p => p.Order_Items)
      .SelectMany(p => p.Order_Items)
      .Sum(p => p.Quantity * p.Price);

    // ---- YORUMLAR ----
    var commentsdate = dbContext.Comments
    .Include(p => p.User)
    .Where(p => p.User.Comments.Any())
    .OrderByDescending(p => p.Date)
    .ToList();

    // ---- AYLAR / YILLIK SATIŞLAR ----
    var monthNames = System.Globalization.CultureInfo.CurrentCulture
        .DateTimeFormat.AbbreviatedMonthNames
        .Where(p => !string.IsNullOrEmpty(p));

    var annualSales = dbContext.shoppedOrders
        .Where(p => p.Status == OrderStatus.Shipped)
        .Include(p => p.Order_Items)
        .GroupBy(p => p.Date.Month)
        .Select(p => new { p.Key, Total = p.Sum(q => q.Order_Items.Sum(r => r.Quantity * r.Price)) })
        .ToList();

    var monthlySales = Enumerable.Range(1, 12)
        .Select(p => annualSales.SingleOrDefault(q => q.Key == p)?.Total ?? 0);

    // ---- EN ÇOK GÖRÜNTÜLENEN ÜRÜNLER ----
    var topviewedProduct = dbContext.Products
        .OrderByDescending(p => p.Views)
        .Take(5)
        .Select(p => new { p.Name, p.Views })
        .ToList();

    var productnames = topviewedProduct.Select(p => p.Name);
    var productviews = topviewedProduct.Select(p => p.Views);

    // ---- SATIŞ REYTINGLERI ----
    var monthlySalesRates = dbContext.shoppedOrders
       .GroupBy(p => p.Date.Month)
.Select(q => new
{
    Month = q.Key,
    Total = q.Count(),
    Completed = q.Count(f => f.Status == OrderStatus.Shipped),
    Rate = q.Count() != 0 ?
        (double)q.Count(f => f.Status == OrderStatus.Shipped) / q.Count() * 100 : 0
})

        .OrderBy(x => x.Month)
        .ToList();

    // ---- AYLIK YENI ÜYELER ----
    var monthlyNewUsers = dbContext.Users
        .GroupBy(p => p.Date.Month)
        .Select(q => new { Month = q.Key, Count = q.Count() })
        .OrderBy(f => f.Month)
        .ToList();

    var currentMonth = DateTime.Now.Month;

    var currentMonthRate = monthlySalesRates
        .FirstOrDefault(x => x.Month == currentMonth)?.Rate ?? 0;

    var currentMonthNewUsers = monthlyNewUsers
        .FirstOrDefault(x => x.Month == currentMonth)?.Count ?? 0;

    // ---- SON 30 GÜN SITE GÖRÜNTÜLENMESI ----
    var monthlySiteViews = dbContext.VisitLogs
        .Count(v => v.StartTime >= lastMonthDate);
    // ---- SON 30 GÜN ORTALAMA SÜRE ----
    var monthlyAvgDurationSec = dbContext.VisitLogs
        .Where(v => v.StartTime >= lastMonthDate && v.DurationSec > 0)
        .Average(v => (double?)v.DurationSec) ?? 0;

    // saniyeyi TimeSpan'a dönüştür
    TimeSpan avgTimeSpan = TimeSpan.FromSeconds(monthlyAvgDurationSec);
    var avgTimeFormatted = $"{(int)avgTimeSpan.TotalMinutes}m:{avgTimeSpan.Seconds}s";

}
<div class="navbar-menu-wrapper d-flex align-items-top">
    <ul class="navbar-nav">
        <li class="nav-item fw-semibold d-none d-lg-block ms-0">
            <h3 class="welcome-sub-text text-bg-info">Bu haftaki performans özetiniz. </h3>

        </li>
    </ul>
</div>

<div class="col-sm-12">
    <div class="home-tab">
        
                <div class="btn-wrapper">
                    <a href="#" class="btn btn-otline-dark align-items-center"><i class="icon-share"></i> Paylaş</a>
                    <a href="#" class="btn btn-otline-dark"><i class="icon-printer"></i> Yazdır</a>
                    <a href="#" class="btn btn-primary text-white me-0"><i class="icon-download"></i></a>
                </div>
            </div>
        </div>
        <div class="tab-content tab-content-basic">
            <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="statistics-details d-flex align-items-center justify-content-between">
                            <div>
                                <p class="statistics-title">Satış Reytingi</p>
                                <h3 class="rate-percentage">@currentMonthRate.ToString("0.00")%</h3>
                                <p class="text-danger d-flex"><i class="mdi mdi-menu-down"></i><span>@currentMonthRate.ToString("0.00")%</span></p>
                            </div>
                            <div>
                                <p class="statistics-title">Site Görüntülenmesi</p>
                                <h3 class="rate-percentage">@monthlySiteViews</h3>
                                <p class="text-success d-flex"><i class="mdi mdi-menu-up"></i><span>@monthlySiteViews.ToString("+0.1%")</span></p>
                            </div>
                            <div>
                                <p class="statistics-title">Yeni Üyelikler</p>
                                <h3 class="rate-percentage">@currentMonthNewUsers</h3>
                                <p class="text-danger d-flex"><i class="mdi mdi-menu-down"></i><span>@currentMonthNewUsers.ToString("+0.1%")</span></p>
                            </div>
                            <div class="d-none d-md-block">
                                <p class="statistics-title">Sitede Ortalama Bulunma Süresi</p>
                                <h3 class="rate-percentage">@avgTimeFormatted</h3>
                                <p class="text-success d-flex"><i class="mdi mdi-menu-down"></i><span>@avgTimeFormatted.ToString()</span></p>
                            </div>


                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 ">
                            <div class="row ">
                                <div class="col-12 grid-margin stretch-card">
                                    <div class="card card-rounded">
                                        <div class="card-body">
                                            <div class="d-sm-flex justify-content-between align-items-start">
                                                <div>
                                                    <h4 class="card-title card-title-dash">Pazardaki Genel Bakış</h4>
                                                    <p class="card-subtitle card-subtitle-dash">Aşağıdaki Brüt Kazanç Oranlarınız</p>
                                                </div>
                                            </div>
                                            <div class="d-sm-flex align-items-center mt-1 justify-content-between">
                                                <div class="d-sm-flex align-items-center mt-4 justify-content-between">
                                                    <h2 class="me-2 fw-bold">@last30DaysGross.ToString("C2")</h2>
                                                </div>
                                                <div class="me-3">
                                                    <div id="marketingOverview-legend"></div>
                                                </div>
                                            </div>
                                            <div class="chartjs-bar-wrapper mt-3">
                                                <canvas id="marketingOverview"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row flex-grow">
                                <div class="col-12 grid-margin stretch-card">
                                    <div class="card card-rounded">
                                        <div class="card-body">
                                            <div class="d-sm-flex justify-content-between align-items-start">
                                                <div>
                                                    <h4 class="card-title card-title-dash">Ürün Yorumları</h4>
                                                    <p class="card-subtitle card-subtitle-dash">Ürünleriniz İçin Kullanıcıların Yapmış Olduğu Yorumlar</p>
                                                </div>
                                               
                                            </div>
                                            <div class="table-responsive  mt-1">
                                                <table class="table select-table">
                                                    <thead>
                                                        <tr>
                                                            <th>Tarih</th>
                                                            <th>Kullanıcı</th>
                                                            <th>Yorumları</th>
                                                            <th>Aktiflik</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <div class="d-flex ">
                                                                @foreach (var item in commentsdate)
                                                                {
                                                                    if (item.User?.Comments?.Any() == true)
                                                                    {
                                                                <tr>
                                                                    <td>@item.Date.ToShortDateString()</td>
                                                                    <td>@item.User.givenName</td>
                                                                    <td>@item.Text</td>
                                                                    <td>@item.User.IsEnabled</td>
                                                                </tr>
                                                            }
                                                        }

                                                    </div>
                                                    </tr>
                                                    </tbody>
                                                    </table>
                                                </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                       
                    </div>
                </div>
            </div>








@section Scripts {
    <script src="~/admin/vendors/chart.js/chart.umd.js"></script>
    <script src="~/admin/vendors/progressbar.js/progressbar.min.js"></script>
    <script src="~/admin/js/dashboard.js"></script>

    <script>
    var ctx = document.getElementById("marketingOverview").getContext('2d');

var existingChart = Chart.getChart("marketingOverview");
if (existingChart) {
    existingChart.destroy();
}

new Chart(ctx, {
    type: 'bar',
    data: {
        labels: [@Html.Raw(string.Join(",", monthNames.Select(p => $"'{p}'")))],
        datasets: [
            {
                label: 'Bu Ay',
                data: [@string.Join(",", monthlySales)],
                backgroundColor: 'navy'
            },
         
        ]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { position: 'top' }
        },
        scales: {
            y: { beginAtZero: true }
        }
    }
});


    </script>

</script>

}