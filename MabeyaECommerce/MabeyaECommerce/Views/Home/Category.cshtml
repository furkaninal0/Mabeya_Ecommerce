@model Category
@{
    ViewData["Title"] = Model.Name;

    var products = Model.Products.Select(p => new ProductTileViewModel
    {
        Id = p.Id,
        Name = p.Name!,
        Price = p.Price,
        CategoryId = p.CategoryId,
        CategoryName = p.Category!.Name!
    });

    var specFilters = Model.Products
        .SelectMany(p => p.ProductDetails)
        .Select(d => new { specName = d.Spec.Name, value = d.Value })
        .Distinct()
        .ToList();
}

<div class="container mt-3">

    <div class="row">

        <div class="col-12 col-md-3">

            <div class="card shadow-sm p-3">

                <h5 class="fw-bold mb-3">@Model.Name Filtreleri</h5>

                <div class="mb-3">
                    <label class="form-label fw-bold">Özellik</label>
                    <select id="specFilter" class="form-select">
                        <option value="">Seçiniz</option>
                        @foreach (var s in specFilters.Select(x => x.specName).Distinct())
                        {
                            <option value="@s">@s</option>
                        }
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Değer</label>
                    <select id="valueFilter" class="form-select">
                        <option value="">Önce özellik seçiniz</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Fiyat Aralığı</label>
                    <input type="number" id="minPrice" class="form-control mb-2" placeholder="Min">
                    <input type="number" id="maxPrice" class="form-control" placeholder="Max">
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Sıralama</label>
                    <select id="sort" class="form-select">
                        <option value="">Varsayılan</option>
                        <option value="new">En Yeni</option>
                        <option value="asc">Ucuzdan Pahalıya</option>
                        <option value="desc">Pahalıdan Ucuza</option>
                    </select>
                </div>

                <button class="btn btn-primary w-100 mt-2" onclick="applyCategoryFilters()">
                    Filtrele
                </button>

            </div>

        </div>

        <div class="col-12 col-md-9">

            <div id="productList">
                <partial name="_ProductListPartial" model="products" />
            </div>

        </div>

    </div>

</div>


@section Scripts{

    <script>

   const specFilters = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
        Model.Products
            .SelectMany(p => p.ProductDetails)
            .Select(d => new { spec = d.Spec.Name, value = d.Value })
            .ToList()
    ));

document.getElementById("specFilter").addEventListener("change", function () {

    let selected = this.value;
    let values = specFilters
        .filter(x => x.spec === selected)
        .map(x => x.value);

    values = [...new Set(values)];

    let valueSelect = document.getElementById("valueFilter");
    valueSelect.innerHTML = "<option value=''>Seçiniz</option>";

    values.forEach(v => {
        valueSelect.innerHTML += `<option value="${v}">${v}</option>`;
    });

});

function applyCategoryFilters() {

    $.ajax({
        url: "/Home/FilterCategoryProducts",
        type: "GET",
        data: {
            categoryId: "@Model.Id",
            spec: $("#specFilter").val(),
            value: $("#valueFilter").val(),
            minPrice: $("#minPrice").val(),
            maxPrice: $("#maxPrice").val(),
            sort: $("#sort").val()
        },
        success: function (html) {
            $("#productList").html(html);
        }
    });

}


    </script>

}
